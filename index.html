<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JSON to Excel Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(
          135deg,
          #e8f5e9 0%,
          #f1f8e9 50%,
          #fff9c4 100%
        );
        padding: 40px 20px;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: linear-gradient(
            rgba(76, 175, 80, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(76, 175, 80, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        pointer-events: none;
        z-index: 0;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 1;
        border-top: 4px solid #4caf50;
      }

      h1 {
        color: #2e7d32;
        margin-bottom: 10px;
        text-align: center;
        font-size: 32px;
      }

      .subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        color: #2e7d32;
        font-weight: 600;
        font-size: 15px;
      }

      input[type="text"] {
        width: 100%;
        padding: 14px;
        border: 2px solid #c8e6c9;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s;
        background-color: #fafafa;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #4caf50;
        background-color: white;
      }

      textarea {
        width: 100%;
        padding: 14px;
        border: 2px solid #c8e6c9;
        border-radius: 6px;
        font-size: 14px;
        font-family: "Courier New", monospace;
        resize: vertical;
        min-height: 350px;
        background-color: #fafafa;
        transition: border-color 0.3s;
      }

      textarea:focus {
        outline: none;
        border-color: #4caf50;
        background-color: white;
      }

      button {
        width: 100%;
        padding: 16px;
        background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .error {
        color: #c62828;
        margin-top: 15px;
        padding: 14px;
        background-color: #ffebee;
        border-radius: 6px;
        display: none;
        border-left: 4px solid #c62828;
        white-space: pre-line;
      }

      .success {
        color: #2e7d32;
        margin-top: 15px;
        padding: 14px;
        background-color: #e8f5e9;
        border-radius: 6px;
        display: none;
        border-left: 4px solid #4caf50;
      }

      .excel-icon {
        text-align: center;
        margin-bottom: 20px;
        font-size: 48px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="excel-icon">ðŸ“Š</div>
      <h1>JSON to Excel Converter</h1>
      <p class="subtitle">
        Convert your JSON data into Excel spreadsheet format
      </p>

      <div class="form-group">
        <label for="title">Excel File Title:</label>
        <input
          type="text"
          id="title"
          placeholder="Enter filename (e.g., data)"
          value="data"
        />
      </div>

      <div class="form-group">
        <label for="jsonInput">JSON Data:</label>
        <textarea
          id="jsonInput"
          placeholder='Paste your JSON here, e.g.,
[
  {"name": "John", "age": 30, "city": "New York"},
  {"name": "Jane", "age": 25, "city": "London"}
]'
        ></textarea>
      </div>

      <div class="error" id="error"></div>
      <div class="success" id="success"></div>

      <button id="downloadBtn" onclick="convertAndDownload()">
        Convert & Download Excel
      </button>
    </div>

    <script>
      function convertAndDownload() {
        const title = document.getElementById("title").value.trim();
        let jsonInput = document.getElementById("jsonInput").value.trim();
        const errorDiv = document.getElementById("error");
        const successDiv = document.getElementById("success");

        errorDiv.style.display = "none";
        successDiv.style.display = "none";

        if (!title) {
          showError("Please enter a title for the Excel file.");
          return;
        }

        if (!jsonInput) {
          showError("Please enter JSON data.");
          return;
        }

        try {
          // Clean up the input: remove trailing semicolons, spaces, and extra characters
          jsonInput = jsonInput
            .trim()
            .replace(/;+\s*$/, "") // Remove trailing semicolons
            .trim(); // Remove any remaining whitespace

          // Convert JavaScript object notation to valid JSON
          let processedInput = jsonInput
            // Replace single quotes with double quotes
            .replace(/'/g, '"')
            // Add quotes to unquoted keys
            .replace(
              /(\s*?{\s*?|\s*?,\s*?)(['"])?([a-zA-Z0-9_]+)(['"])?:/g,
              '$1"$3":'
            )
            // Wrap unquoted values (like dates, numbers with special chars) in quotes
            // This handles cases like: key: 2025-09-16T11:45:45.056Z
            .replace(
              /:\s*([^,}\]"'\s][^,}\]"']*[^,}\]"'\s])\s*([,}\]])/g,
              function (match, value, ending) {
                // Don't quote if it's already a number, boolean, or null
                if (
                  /^-?\d+\.?\d*$/.test(value.trim()) ||
                  value.trim() === "true" ||
                  value.trim() === "false" ||
                  value.trim() === "null"
                ) {
                  return ": " + value + ending;
                }
                // Quote everything else (dates, strings with special chars, etc)
                return ': "' + value.trim() + '"' + ending;
              }
            );

          const jsonData = JSON.parse(processedInput);

          if (!Array.isArray(jsonData)) {
            showError("JSON data must be an array of objects.");
            return;
          }

          if (jsonData.length === 0) {
            showError("JSON array cannot be empty.");
            return;
          }

          const worksheet = XLSX.utils.json_to_sheet(jsonData);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "Sheet1");

          const filename = title.endsWith(".xlsx") ? title : `${title}.xlsx`;
          XLSX.writeFile(workbook, filename);

          showSuccess(
            `Excel file "${filename}" has been downloaded successfully!\n\nNote: File will be available in your downloads folder.`
          );
        } catch (error) {
          // Try to find which object caused the error
          let errorDetails = `Error: ${error.message}`;

          // Attempt to find the problematic object by parsing line by line
          try {
            const lines = jsonInput.split("\n");
            let currentId = null;
            let objectCount = 0;

            for (let i = 0; i < lines.length; i++) {
              const line = lines[i].trim();

              // Count objects
              if (line.startsWith("{")) {
                objectCount++;
              }

              // Try to find id in the line
              const idMatch = line.match(/id['":\s]*(\d+)/i);
              if (idMatch) {
                currentId = idMatch[1];
              }
            }

            if (currentId) {
              errorDetails += `\n\nLast detected ID before error: ${currentId}`;
              errorDetails += `\nObject number: ~${objectCount}`;
            }
          } catch (e) {
            // If we can't determine the ID, just show the original error
          }

          showError(errorDetails);
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        errorDiv.textContent = message;
        errorDiv.style.display = "block";
      }

      function showSuccess(message) {
        const successDiv = document.getElementById("success");
        successDiv.textContent = message;
        successDiv.style.display = "block";
      }

      // Tab key support for textarea
      document
        .getElementById("jsonInput")
        .addEventListener("keydown", function (e) {
          if (e.key === "Tab") {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            this.value =
              this.value.substring(0, start) + "  " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 2;
          }
        });
    </script>
  </body>
</html>
